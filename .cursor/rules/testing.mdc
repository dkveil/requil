---
alwaysApply: false
globs:
  - "**/*.test.ts"
  - "**/*.test.tsx"
  - "**/*.spec.ts"
  - "**/*.spec.tsx"
  - "**/test/**"
  - "**/tests/**"
  - "**/__tests__/**"
---

# Testing Guidelines

## Framework & Tools

- **Unit + Integration**: Vitest + Testcontainers (Postgres)
- **E2E**: Playwright (Chromium only)
- **Coverage**: >80% business logic, run only when asked

## Vitest (Unit + Integration)

**Core Patterns**:

- `vi.mock()` factory patterns at top level, typed implementations
- Setup files for global mocks/matchers in `vitest.config.ts`
- Watch mode (`vitest --watch`) during development
- Arrange-Act-Assert pattern, descriptive `describe` blocks

**Unit Tests**:

- Pure functions, validators, helpers
- `environment: 'jsdom'` for React components
- Mock all external dependencies

**Integration Tests**:

- Testcontainers for isolated Postgres instances
- Transactional tests with rollback for isolation
- Mock external services: Supabase Auth, Resend, QStash (when needed)
- Real or mock Upstash Redis for rate limiting
- Run drizzle-kit migrations before tests, cleanup in afterAll

### Requil API Testing Priorities

**Templates & Rendering**:

- React Email (TSX) validation, AI Generate output, compilation to HTML
- Guardrails: WCAG AA contrast, 100% alt-text, HTTPS only, HTML < 150 kB
- Variables schema (strict/permissive), plaintext generation
- Snapshot publication (immutable), Redis cache

**Send & Transports**:

- POST /v1/send (single/multiple recipients, per-recipient variables)
- Transport selection (Resend/SMTP), deliverability headers
- Suppression list, failed_recipients handling

**Orchestration**:

- Rate limiting (Redis, per workspace/transport)
- Idempotency (duplicate prevention, partial failures)
- QStash retry (exponential backoff), fan-out batches

**Security**:

- Webhook HMAC signatures, API Keys + scopes, RLS policies
- SMTP credentials encryption, audit logs

## Playwright (E2E Tests)

**Configuration**:

- Chromium only, browser contexts for isolation
- Page Object Model for maintainability
- Resilient locators, trace viewer for debugging
- Playwright fixtures for test data, cleanup in afterEach

**Critical Flows**:

- **Auth**: Registration, login (email/OAuth), password recovery, session management
- **Templates**: AI Generate, editor (drag-and-drop blocks), variables panel, quality checklist, snapshot publish
- **Send**: Campaign creation, preview, send with test recipients, failed recipient handling
- **UX**: Responsive design, keyboard navigation, form validation, toast notifications

**Test Data**:

- Separate Supabase test organizations
- Mock external services (Resend, QStash) when appropriate

## Package-Specific Testing Focus

**email-engine**: React Email compilation, Liquid variables, inline CSS, plaintext generation, XSS prevention
**validation**: WCAG contrast (calculation + auto-fix), alt-text detection, HTTPS enforcement, HTML size limits (Cheerio)
**transports**: Resend/SMTP integration (mock responses), bounce/complaint webhooks, suppression list updates
**ratelimit**: Token bucket algorithm (time mocking), Redis TTL, per-workspace/transport limits, 429 responses
**CQRS handlers**: Commands with mocked dependencies, validation, error mapping, transactional rollback
**Idempotency**: Redis lock acquisition, cached results, body hash conflicts, partial failures, TTL expiration
